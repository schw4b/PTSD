---
title: "PTSD"
author: "Simon Schwab"
date: "24 Sep 2017"
output:
  html_notebook: default
  html_document: default
---

## Libraries
```{r}
# install.packages("ggplot2")
# install.packages("cowplot")
# install.packages("foreign")
# install.packages("testit")
# install.packages("car")
# install.packages("reshape2")

library(ggplot2)
library(cowplot)
library(foreign)
library(testit)
library(car)
library(reshape2)
```

## Variables and paths
```{r}
N = 1002

PATH_HOME = '/home/simon'
PATH = file.path(PATH_HOME, 'Dropbox', 'Data', 'PTSD')
PATH_DATA = file.path(PATH, 'data')
```

## Load data
```{r}
d = read.spss(file.path(PATH_DATA, 'PTSD_Skalen_1 06 2017_GESAMT.sav'), 
              to.data.frame = T)
assert(nrow(d) == N)

# Some ids are dublicates but in fact different subjects, thus we recreate the IDs
d$id = as.factor(1:N)

g1 = d$arbeitsort=='Sanität, Ambulanz'
g2 = d$arbeitsort=='Feuerwehr'
g3 = d$arbeitsort=='Polizei'
g4 = d$arbeitsort=='Spitalnotfall'
g5 = d$arbeitsort=='Psychiatrie'

## Create subgroups
d.g1 = subset(d, g1)
d.g2 = subset(d, g2)
d.g3 = subset(d, g3)
d.g4 = subset(d, g4)
d.g5 = subset(d, g5)

labels = c('Sanität, Ambulanz', 'Feuerwehr', 'Polizei', 'Spitalnotfall', 'Psychiatrie')
n = summary(d$arbeitsort)
```
## Descriptives
### Global Gender, Arbeitsort and Group
```{r}
summary(d$geschlecht)
summary(d$arbeitsort)
summary(d$group)
```

### Mean age per group
```{r}
tapply(d$alter, d$arbeitsort, mean)
```

### Gender per Group
```{r}
tapply(d$geschlecht, d$arbeitsort, summary)
```


## PTSS difference in mean between Groups
```{r 2, fig.height=2, fig.width=10}
p1=ggplot(data=d, aes(x=arbeitsort, y=PTSS_Skala, fill=arbeitsort)) +
  geom_bar(stat="summary", fun.y="mean") +
  theme(axis.text.x=element_blank())

p2=ggplot(data=d, aes(x=arbeitsort, y=PTSS_Skala, fill=arbeitsort)) +
  geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.3, position = position_jitter(width = 0.3, height = 1)) +
  theme(axis.text.x=element_blank())

plot_grid(p1, p2, ncol = 2, nrow = 1, rel_widths = c(1, 1))
```

### ANOVA
```{r}
fit=aov(PTSS_Skala ~ arbeitsort, data=d)
summary(fit)
```

```{r}
M=array(NA, dim=c(5,2))
M[1,] = summary(d$PSS_Gr[g1])/n[1]
M[2,] = summary(d$PSS_Gr[g2])/n[2]
M[3,] = summary(d$PSS_Gr[g3])/n[3]
M[4,] = summary(d$PSS_Gr[g4])/n[4]
M[5,] = summary(d$PSS_Gr[g5])/n[5]

rownames(M)=labels
colnames(M)=c('kein Verdacht', 'Verdacht')
print(M, digits = 2)
```

## Multiple regressions
We perform **subgroup analyses**.

### Sanität
```{r}
fit = lm(PTSS_Skala ~ cope_problfoc_active + cope_dysfunct_subst +
           cope_dysfunct_avoid + TraumaArbeit + TraumaVorBeruf +
           SWE_Skala + dauer + alter + geschlecht, data=d.g1)
vif(fit) > 4
summary(fit)
```
### Feuerwehr
```{r}
fit = lm(PTSS_Skala ~ cope_problfoc_active + cope_dysfunct_subst +
           cope_dysfunct_avoid + TraumaArbeit + TraumaVorBeruf +
           SWE_Skala + dauer + alter + geschlecht, data=d.g2)
vif(fit) > 4
summary(fit)
```

### Polizei
```{r}
fit = lm(PTSS_Skala ~ cope_problfoc_active + cope_dysfunct_subst +
           cope_dysfunct_avoid + TraumaArbeit + TraumaVorBeruf +
           SWE_Skala + dauer + alter + geschlecht, data=d.g3)
vif(fit) > 4
summary(fit)
```
### Spitalnotfall
```{r}
fit = lm(PTSS_Skala ~ cope_problfoc_active + cope_dysfunct_subst +
           cope_dysfunct_avoid + TraumaArbeit + TraumaVorBeruf +
           SWE_Skala + dauer + alter + geschlecht, data=d.g4)
vif(fit) > 4
summary(fit)
```

### Psychiatrie
```{r}
fit = lm(PTSS_Skala ~ cope_problfoc_active + cope_dysfunct_subst +
           cope_dysfunct_avoid + TraumaArbeit + TraumaVorBeruf +
           SWE_Skala + dauer + alter + geschlecht, data=d.g5)
vif(fit) > 4
summary(fit)
```

### Multicolinearity
```{r, fig.height=6, fig.width=6}
tmp=d.g1
x = cbind(tmp$cope_problfoc_active, tmp$cope_dysfunct_subst,
    tmp$cope_dysfunct_avoid, tmp$TraumaArbeit, tmp$TraumaVorBeruf, tmp$SWE_Skala,
    tmp$dauer, tmp$alter, tmp$geschlecht)

p1 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)

tmp=d.g2
x = cbind(tmp$cope_problfoc_active, tmp$cope_dysfunct_subst,
    tmp$cope_dysfunct_avoid, tmp$TraumaArbeit, tmp$TraumaVorBeruf, tmp$SWE_Skala,
    tmp$dauer, tmp$alter, tmp$geschlecht)

p2 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)

tmp=d.g3
x = cbind(tmp$cope_problfoc_active, tmp$cope_dysfunct_subst,
    tmp$cope_dysfunct_avoid, tmp$TraumaArbeit, tmp$TraumaVorBeruf, tmp$SWE_Skala,
    tmp$dauer, tmp$alter, tmp$geschlecht)

p3 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)

tmp=d.g4
x = cbind(tmp$cope_problfoc_active, tmp$cope_dysfunct_subst,
    tmp$cope_dysfunct_avoid, tmp$TraumaArbeit, tmp$TraumaVorBeruf, tmp$SWE_Skala,
    tmp$dauer, tmp$alter, tmp$geschlecht)

p4 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)

tmp=d.g5
x = cbind(tmp$cope_problfoc_active, tmp$cope_dysfunct_subst,
    tmp$cope_dysfunct_avoid, tmp$TraumaArbeit, tmp$TraumaVorBeruf, tmp$SWE_Skala,
    tmp$dauer, tmp$alter, tmp$geschlecht)

p5 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)

plot_grid(p1, p2, p3, p4 , p5, ncol = 2, nrow = 3)
```






