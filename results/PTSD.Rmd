---
title: "PTSD"
author: "Simon Schwab"
date: "26 July 2018"
output: html_notebook
---

## Libraries
```{r message=FALSE}
 # install.packages("ggplot2")
 # install.packages("cowplot")
 # install.packages("foreign")
 # install.packages("testit")
 # 
 # # sudo apt-get install libcurl4-openssl-dev
 # install.packages("car")
 # install.packages("reshape2")
 # install.packages("caret")

library(ggplot2)
library(cowplot)
library(foreign)
library(testit)
library(car)
library(reshape2)
library(caret)
```

## Variables and paths
```{r}
N = 1002

#PATH_HOME = '/home/simon'
PATH_HOME = '/Users/simonschwab'
PATH = file.path(PATH_HOME, 'Dropbox', 'Data', 'PTSD')
PATH_DATA = file.path(PATH, 'data')
PATH_FIGURES = file.path(PATH, 'figures')
```

## Load data
```{r} 
mydata = read.spss(file.path(PATH_DATA, 'PTSD_Skalen_1 06 2017_GESAMT_LS.sav'), 
              to.data.frame = T)
assert(nrow(mydata) == N)
varNames = names(mydata)

# Some ids are dublicates but in fact different subjects, thus we recreate the IDs
mydata$id_new = as.factor(1:N)

mydata$arbeitsort.eng =  as.character(mydata$arbeitsort)
mydata$arbeitsort.eng[mydata$arbeitsort.eng=="SanitÃ¤t, Ambulanz"] = "Ambulance service"
mydata$arbeitsort.eng[mydata$arbeitsort.eng=="Feuerwehr"] = "Fire service"
mydata$arbeitsort.eng[mydata$arbeitsort.eng=="Polizei"] = "Police"
mydata$arbeitsort.eng[mydata$arbeitsort.eng=="Spitalnotfall"] = "Emergency staff"
mydata$arbeitsort.eng[mydata$arbeitsort.eng=="Psychiatrie"] = "Psychiatry"
mydata$arbeitsort.eng = factor(mydata$arbeitsort.eng, ordered = T,
                               levels = c("Police", "Fire service", "Ambulance service",
                                          "Emergency staff", "Psychiatry"))

N_perGroup = summary(mydata$arbeitsort.eng)
```

## Create variables
```{r}
mydata$s001 = rep(NA, N)

mydata$s001[mydata$hilfeBelastEinsatz_SQ001 == "gar nicht"] = 1
mydata$s001[mydata$hilfeBelastEinsatz_SQ001 == "wenig"] = 2
mydata$s001[mydata$hilfeBelastEinsatz_SQ001 == "etwas"] = 3
mydata$s001[mydata$hilfeBelastEinsatz_SQ001 == "stark"] = 4
mydata$s001[mydata$hilfeBelastEinsatz_SQ001 == "sehr stark"] = 5

mydata$s012 = rep(NA, N)

mydata$s012[mydata$hilfeBelastEinsatz_SQ012 == "gar nicht"] = 1
mydata$s012[mydata$hilfeBelastEinsatz_SQ012 == "wenig"] = 2
mydata$s012[mydata$hilfeBelastEinsatz_SQ012 == "etwas"] = 3
mydata$s012[mydata$hilfeBelastEinsatz_SQ012 == "stark"] = 4
mydata$s012[mydata$hilfeBelastEinsatz_SQ012 == "sehr stark"] = 5

mydata$s013 = rep(NA, N)

mydata$s013[mydata$hilfeBelastEinsatz_SQ013 == "gar nicht"] = 1
mydata$s013[mydata$hilfeBelastEinsatz_SQ013 == "wenig"] = 2
mydata$s013[mydata$hilfeBelastEinsatz_SQ013 == "etwas"] = 3
mydata$s013[mydata$hilfeBelastEinsatz_SQ013 == "stark"] = 4
mydata$s013[mydata$hilfeBelastEinsatz_SQ013 == "sehr stark"] = 5

assert(all(!is.na(mydata$s001)))
assert(all(!is.na(mydata$s012)))
assert(all(!is.na(mydata$s013)))

mydata$support = (mydata$s001 + mydata$s012 + mydata$s013)/3

```


## Check variables
```{r}
summary(mydata$wohnsituation)
mydata$id[which(mydata$wohnsituation=="7")] # 4 cases have factor "7"

summary(mydata$schwierigesEreignis)
mydata$id[which(mydata$schwierigesEreignis=="4")] # 4 bedeutet 
```


## Demographics

### Summary
```{r}
#names(d)
summary(mydata[,c(10,
             164:166,171:172,15,6,4,5,
             16:18,20:22,25)])
```

### N per group
```{r}
summary(mydata$arbeitsort.eng)
```

### Mean age and SD per group
```{r}
round(tapply(mydata$alter, mydata$arbeitsort.eng, mean), digits = 1)
round(tapply(mydata$alter, mydata$arbeitsort.eng, sd), digits = 2)
```

### Gender per Group
```{r}
round(tapply(mydata$geschlecht=='Frau', mydata$arbeitsort.eng, sum)/summary(mydata$arbeitsort.eng), digits = 2)
```

### Work experience
```{r}
round(tapply(mydata$dauer, mydata$arbeitsort.eng, mean), digits = 1)
round(tapply(mydata$dauer, mydata$arbeitsort.eng, sd), digits = 2)
```

### Civil status
```{r}
round(tapply(mydata$zivilstand == "Verheiratet / feste Partnerschaft",
             mydata$arbeitsort.eng, sum)/summary(mydata$arbeitsort.eng), digits = 2)
```

## Clinical variables
### PTSS
```{r}
tapply(mydata$PTSS_Skala, mydata$arbeitsort.eng, median)
tapply(mydata$PTSS_Skala, mydata$arbeitsort.eng, IQR)
```


```{r, fig.height=2, fig.width=5}
set.seed(1980)

p1 = ggplot(data=mydata, aes(x=arbeitsort, y=PTSS_Skala, fill=arbeitsort.eng)) +
  geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.3, position = position_jitter(width = 0.3, height = 0)) +
  theme(axis.text.x=element_blank()) + xlab("occupational group") + ylab("PTSS score")

plot_grid(p1, ncol = 1, nrow = 1, rel_widths = c(1, 1))
ggsave(path = PATH_FIGURES, "fig_PTSS_per_group.png")
```

### ANOVA
```{r}
fit=aov(PTSS_Skala ~ arbeitsort.eng + dauer + alter + geschlecht, data=mydata)
summary(fit)
```

### Verdacht
```{r}
x = tapply(mydata$PSS_Gr == "Verdacht auf PTSD > 12.5", mydata$arbeitsort.eng, sum)
round(x/N_perGroup, digits = 2)
prop.test(x, summary(mydata$arbeitsort.eng))
```

### Trauma before
```{r}
x = tapply(mydata$TraumaVorBeruf == ">1 Traumata", mydata$arbeitsort.eng, sum)
round(x/N_perGroup, digits = 2)
```

### Trauma during work
```{r}
x = tapply(mydata$TraumaArbeit == ">1 Traumata", mydata$arbeitsort.eng, sum)
round(x/N_perGroup, digits = 2)
```

### BSCL
```{r}
round(tapply(mydata$BSCL_GSI, mydata$arbeitsort.eng, median), digits = 2)
round(tapply(mydata$BSCL_GSI, mydata$arbeitsort.eng, IQR), digits = 2)

tapply(mydata$BSCL_PST, mydata$arbeitsort.eng, median)
tapply(mydata$BSCL_PST, mydata$arbeitsort.eng, IQR)

round(tapply(mydata$BSCL_PSDI, mydata$arbeitsort.eng, function(x) median(x, na.rm = T)), digits = 2)
round(tapply(mydata$BSCL_PSDI, mydata$arbeitsort.eng, function(x) IQR(x, na.rm = T)), digits = 2)
```

### GHQ
```{r}
tapply(mydata$GHQ_SUM, mydata$arbeitsort.eng, median)
tapply(mydata$GHQ_SUM, mydata$arbeitsort.eng, IQR)
```

### Self efficacy
```{r}
tapply(mydata$SWE_Skala, mydata$arbeitsort.eng, function(x) median(x, na.rm = T))
tapply(mydata$SWE_Skala, mydata$arbeitsort.eng, function(x) IQR(x, na.rm = T))
```

## Multiple regression

### Model
```{r}
fit = lm(PTSS_Skala ~ arbeitsort + dauer + geschlecht +
           cope_problfoc_active + cope_dysfunct_subst + cope_dysfunct_avoid + 
           TraumaArbeit + TraumaVorBeruf +
           SWE_Skala*arbeitsort + support
           , data=mydata)

summary(fit)
```

### Rel. importance
```{r}
x = varImp(fit, scale = FALSE)
idx = order(x$Overall, decreasing = T)
table=data.frame(Overall = x[idx,])
rownames(table) = rownames(x)[idx]
print(round(table, digits = 2))
```

### Collinearity
```{r}
vif(fit) > 4
```

```{r, fig.height=2, fig.width=3}
x = cbind(mydata$cope_problfoc_active, mydata$cope_dysfunct_subst,
    mydata$cope_dysfunct_avoid, mydata$TraumaArbeit, mydata$TraumaVorBeruf, mydata$SWE_Skala,
    mydata$dauer, mydata$alter, mydata$geschlecht)

p1 = ggplot(melt(cor(x)), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60")  + 
  scale_fill_gradient2(low='blue', mid='white', high='red', limit = c(-1,1)) +
  scale_x_continuous(breaks=1:9,labels=1:9) +
  scale_y_reverse(breaks=1:9,labels=1:9)


plot_grid(p1, ncol = 1, nrow = 1)
```

## SEM
A good model fit is considered as follows:
* CFI ideally larger than 0.9
* RMSEA below 0.10

Model specification

`=~` for latent variables
`~`  causal relationshop
`~~` correlation

Data screening/ SEM assumptions

* Missing values
* normality
* Outliers 

```{r}
# install.packages("lavaan")
library(lavaan)
```

### Model specification

```{r}
# model = 'Belastung =~ BSCL_PST + BSCL_GSI + GHQ_Psy + GHQ_Emot
#          dysfunctional =~ cope_dysfunct_subst +
#                           cope_dysfunct_avoid
#          dysfunctional ~ SWE_Skala + TraumaVorBeruf + TraumaArbeit
#          PTSS_Skala ~ cope_problfoc_active + 
#                       dysfunctional +
#                       dauer +
#                       geschlecht
#          Belastung ~ PTSS_Skala'

model = 'Belastung =~ BSCL_PST + BSCL_GSI + GHQ_Psy + GHQ_Emot
         dysfunctional =~ cope_dysfunct_subst +
                          cope_dysfunct_avoid
         PTSS_Skala ~ cope_problfoc_active + 
                      SWE_Skala + 
                      TraumaVorBeruf +
                      TraumaArbeit +
                      dysfunctional +
                      dauer +
                      geschlecht
         Belastung ~ PTSS_Skala'

# model = 'Belastung =~ BSCL_PST + BSCL_GSI + GHQ_Psy + GHQ_Emot
#          dysfunctional =~ cope_dysfunct_subst +
#                           cope_dysfunct_avoid
#          PTSS_Skala ~ cope_problfoc_active + 
#                       SWE_Skala + 
#                       TraumaVorBeruf +
#                       TraumaArbeit +
#                       dysfunctional +
#                       dauer +
#                       geschlecht +
#                       s013
#          Belastung ~ PTSS_Skala'
```

### Fit
```{r}
fit = sem(model=model, data=mydata, group = "arbeitsort.eng")

summary(fit, fit.measures=TRUE, standardized=TRUE)
```

### Variance explained
```{r}
inspect(fit, "rsquare")
# parameterEstimates(fit, ci = TRUE, boot.ci.type = "norm")
```
